üìÑ 008b.task.md: –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–ª–æ—è

üß† –¶–µ–ª—å:

–£–ø—Ä–æ—Å—Ç–∏—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏, –≤—ã–¥–µ–ª–∏–≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–ª–æ–∏ –¥–ª—è —Å–±–æ—Ä–∫–∏ prompt-–æ–≤, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π, –∞ —Ç–∞–∫–∂–µ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —á–∞—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ UI.

‚∏ª

‚úÖ –ü–æ–¥–∑–∞–¥–∞—á–∏:

1. AgentManager –∫–∞–∫ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤—ã–∑–æ–≤–∞ think()
	‚Ä¢	–°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å AgentManager, –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –∞–≥–µ–Ω—Ç–∞–º.
	‚Ä¢	–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã:
	‚Ä¢	route_message_to_agent(agent_id, user_message, *, context, metadata)
	‚Ä¢	–í–Ω—É—Ç—Ä–∏ ‚Äî –æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ agent.think(...) —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º, –∑–∞–º–µ—Ä–æ–º –≤—Ä–µ–º–µ–Ω–∏, —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–æ–π –æ—à–∏–±–æ–∫.
	‚Ä¢	–ó–∞–º–µ–Ω–∏—Ç—å –ø—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã character.think(...) –≤ router.py –Ω–∞ –≤—ã–∑–æ–≤—ã —á–µ—Ä–µ–∑ AgentManager.

2. ChatContextBuilder
	‚Ä¢	–í—ã–Ω–µ—Å—Ç–∏ —Å–±–æ—Ä–∫—É scene_context, arc_context, user_message –∏ –¥—Ä. –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å:

class ChatContextBuilder:
    def build_context(character_id: str, user_message: str) -> Dict


	‚Ä¢	–≠—Ç–æ—Ç —Å–ª–æ–π –¥–æ–ª–∂–µ–Ω:
	‚Ä¢	–ø–æ–ª—É—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Reflector, LoreEngine, NarrativeEngine
	‚Ä¢	—Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Ö–æ–¥–Ω–æ–π prompt
	‚Ä¢	–¥–æ–±–∞–≤–ª—è—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ (–Ω–∞–ø—Ä., current_arc.phase_id)
	‚Ä¢	–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –≤ AgentManager.

3. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
	‚Ä¢	–†–∞—Å—à–∏—Ä–∏—Ç—å POST /tvshow/chat:
	‚Ä¢	–ï—Å–ª–∏ character_id –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ —Å—Ü–µ–Ω—É –±–µ–∑ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.
	‚Ä¢	–¢–∞–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –ø–æ–ø–∞—Å—Ç—å –≤ Reflector, —á–∞—Ç –∏ –≤ –æ–±—â—É—é —Å—Ü–µ–Ω—É.
	‚Ä¢	–ù–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è think(), –Ω–æ –º–æ–∂–µ—Ç –≤–ª–∏—è—Ç—å –Ω–∞ –∞—Ä–∫–∏ –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω.

4. –ú–µ—Ç–∫–∏ arc_id, phase_id –≤ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
	‚Ä¢	–î–æ–±–∞–≤–∏—Ç—å –≤ chat_history —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É:

{
  "character_id": "emma",
  "content": "...",
  "timestamp": ...,
  "arc_id": "what_is_humanity",
  "phase_id": "conflict"
}


	‚Ä¢	–ò–∑–≤–ª–µ–∫–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π arc_id, phase_id –∏–∑ ScenarioManager.get_current_arc_context()
	‚Ä¢	–û–±–Ω–æ–≤–∏—Ç—å WebSocket-—Å–æ–æ–±—â–µ–Ω–∏—è –∏ REST-–æ—Ç–≤–µ—Ç—ã (/chat, /chat/history) –¥–ª—è UI-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏

‚∏ª

üì¶ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:
	‚Ä¢	core/agents/agent_manager.py
	‚Ä¢	core/agents/context_builder.py
	‚Ä¢	–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ router.py, scenario_manager.py, reflector.py

‚∏ª

üîÅ –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
	‚Ä¢	–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ–±—ã –≤—Å–µ –≤—ã–∑–æ–≤—ã think() –±—ã–ª–∏ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω—ã
	‚Ä¢	–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
	‚Ä¢	–í–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å arc_id/phase_id –≤ UI-—á–∞—Ç–µ (–µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –ø—Ä–æ—Ç–æ—Ç–∏–ø)

